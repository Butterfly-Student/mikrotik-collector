{{ template "layout_header" . }}

{{ template "topbar" . }}

<div class="form-container">
    <div style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 style="font-size: 1.5rem; color: var(--gray-900); font-weight: 700;">Edit Customer</h2>
            <p style="color: var(--gray-600); margin-top: 4px;">Update customer details.</p>
        </div>
        <button id="delete-btn" class="btn btn-danger" type="button">
            <i class="fa-solid fa-trash"></i> Delete
        </button>
    </div>

    <div id="loading-msg" style="text-align: center; padding: 20px;">Loading...</div>

    <form id="edit-customer-form" style="display: none;">
        <input type="hidden" id="customer-id">

        <div class="form-group">
            <label class="form-label">Full Name</label>
            <input type="text" name="name" id="f-name" class="form-input" required>
        </div>

        <div class="form-group">
            <label class="form-label">App Username</label>
            <input type="text" name="username" id="f-username" class="form-input" required>
        </div>

        <div class="form-group">
            <label class="form-label">Service Type</label>
            <select name="service_type" class="form-select" id="service-type-select">
                <option value="pppoe">PPPoE</option>
                <option value="hotspot">Hotspot</option>
            </select>
        </div>

        <div id="pppoe-fields">
            <div class="form-group">
                <label class="form-label">PPPoE Username</label>
                <input type="text" name="pppoe_username" id="f-pppoe-username" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">PPPoE Password (leave blank to keep unchangd)</label>
                <input type="password" name="pppoe_password" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">PPPoE Profile</label>
                <input type="text" name="pppoe_profile" id="f-pppoe-profile" class="form-input">
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Phone Number</label>
            <input type="tel" name="phone" id="f-phone" class="form-input">
        </div>

        <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" name="email" id="f-email" class="form-input">
        </div>

        <div class="form-actions">
            <a href="/" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary">
                <i class="fa-solid fa-save"></i> Update Customer
            </button>
        </div>
    </form>
</div>

{{ template "layout_footer" . }}

{{ define "styles" }}
{{ end }}

{{ define "scripts" }}
<script>
    const form = document.getElementById('edit-customer-form');
    const typeSelect = document.getElementById('service-type-select');
    const pppoeFields = document.getElementById('pppoe-fields');
    const loading = document.getElementById('loading-msg');

    // Get ID from URL path (served by Gin as /customers/edit/:id)
    const pathParts = window.location.pathname.split('/');
    const customerId = pathParts[pathParts.length - 1]; // Simply taking last part

    document.getElementById('customer-id').value = customerId;

    typeSelect.addEventListener('change', () => {
        if (typeSelect.value === 'pppoe') {
            pppoeFields.style.display = 'block';
        } else {
            pppoeFields.style.display = 'none';
        }
    });

    // Fetch data
    fetch(`/api/customers/${customerId}`)
        .then(r => r.json())
        .then(resp => {
            if (resp.status === 'success') {
                const c = resp.data;
                document.getElementById('f-name').value = c.name;
                document.getElementById('f-username').value = c.username;
                document.getElementById('service-type-select').value = c.service_type;
                document.getElementById('f-pppoe-username').value = c.pppoe_username || '';
                document.getElementById('f-pppoe-profile').value = c.pppoe_profile || '';
                document.getElementById('f-phone').value = c.phone || '';
                document.getElementById('f-email').value = c.email || '';

                if (c.service_type === 'pppoe') {
                    pppoeFields.style.display = 'block';
                } else {
                    pppoeFields.style.display = 'none';
                }

                form.style.display = 'block';
                loading.style.display = 'none';
            } else {
                loading.innerHTML = '<span style="color:red">Customer not found</span>';
            }
        })
        .catch(err => {
            console.error(err);
            loading.innerHTML = '<span style="color:red">Error loading customer</span>';
        });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        const payload = {
            name: data.name,
            username: data.username,
            service_type: data.service_type,
            phone: data.phone || null,
            email: data.email || null,
            pppoe_username: data.pppoe_username || null,
            pppoe_profile: data.pppoe_profile || null
        };

        if (data.pppoe_password) {
            payload.pppoe_password = data.pppoe_password;
        }

        try {
            const res = await fetch(`/api/customers/${customerId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const result = await res.json();

            if (res.ok && result.status === 'success') {
                alert('Customer updated successfully!');
                window.location.href = '/?customer_id=' + customerId;
            } else {
                alert('Error: ' + (result.message || 'Unknown error'));
            }
        } catch (err) {
            console.error(err);
            alert('Failed to update form');
        }
    });

    document.getElementById('delete-btn').addEventListener('click', async () => {
        if (confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
            try {
                const res = await fetch(`/api/customers/${customerId}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    alert('Customer deleted');
                    window.location.href = '/';
                } else {
                    alert('Failed to delete');
                }
            } catch (e) {
                alert('Error deleting');
            }
        }
    });
</script>
{{ end }}